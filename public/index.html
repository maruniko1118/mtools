<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mtools</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* --- テーマ変数定義 --- */
        :root {
            /* ライトテーマ (デフォルト) */
            --bg-body: #ffffff;
            --bg-sidebar: #f0f4f9;
            --bg-card: #ffffff;
            --bg-input: #ffffff;
            --text-main: #1f1f1f;
            --text-sub: #444746;
            --border-color: #e0e0e0;
            --accent-red: #b3261e;
            --accent-yellow: #f1c40f;
            --hover-bg: #e1e5ea;
            --sidebar-width: 280px;
            --shadow-color: rgba(0,0,0,0.1);
        }

        /* ダークテーマ上書き */
        [data-theme="dark"] {
            --bg-body: #131314;
            --bg-sidebar: #1e1f20;
            --bg-card: #1e1f20;
            --bg-input: #2a2b2d;
            --text-main: #e3e3e3;
            --text-sub: #c4c7c5;
            --border-color: #444746;
            --accent-red: #f2b8b5;
            --accent-yellow: #f1c40f;
            --hover-bg: #333537;
            --shadow-color: rgba(0,0,0,0.5);
        }

        body {
            font-family: "Google Sans", "Helvetica Neue", Arial, sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg-body);
            color: var(--text-main);
            display: flex;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden; /* 横スクロール防止 */
        }

        /* --- ヘッダーエリア --- */
        .header-controls {
            position: fixed; top: 10px; left: 10px; z-index: 1001;
            display: flex; gap: 8px; align-items: center;
        }
        .icon-btn {
            background: none; border: none; cursor: pointer;
            width: 48px; height: 48px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: var(--text-sub); transition: background-color 0.2s;
        }
        .icon-btn:hover { background-color: var(--hover-bg); color: var(--text-main); }
        .icon-btn svg { width: 24px; height: 24px; fill: currentColor; }

        /* --- サイドバー --- */
        .sidebar {
            width: var(--sidebar-width); background-color: var(--bg-sidebar);
            height: 100vh; position: fixed; left: calc(var(--sidebar-width) * -1);
            top: 0; transition: left 0.3s cubic-bezier(0.2, 0, 0, 1);
            z-index: 1000; display: flex; flex-direction: column;
            padding-top: 70px; box-sizing: border-box;
            border-right: 1px solid var(--border-color);
        }
        .sidebar.active { left: 0; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 0 12px; }
        .sidebar-footer { padding: 12px; border-top: 1px solid var(--border-color); }

        .nav-item {
            display: flex; align-items: center; padding: 12px 24px;
            margin-bottom: 4px; border-radius: 24px; cursor: pointer;
            color: var(--text-main); font-weight: 500; transition: background-color 0.2s;
        }
        .nav-item:hover { background-color: var(--hover-bg); }
        .nav-item.current { background-color: var(--hover-bg); font-weight: bold; }

        /* --- メインコンテンツ --- */
        .main-content {
            flex: 1;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            /* 小画面用にパディングを調整 */
            padding: 80px 20px 40px; 
            box-sizing: border-box; /* パディングを含めた幅計算 */
            transition: margin-left 0.3s cubic-bezier(0.2, 0, 0, 1); /* スムーズな移動 */
            
            /* 長い単語でのレイアウト崩れ防止 */
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* PC画面 (幅768px以上) の挙動 */
        @media (min-width: 768px) {
            /* サイドバーが開いている時、コンテンツを右にずらして重ならないようにする */
            .sidebar.active ~ .main-content {
                margin-left: var(--sidebar-width);
                width: calc(100% - var(--sidebar-width)); /* 幅を再計算してはみ出し防止 */
            }
            
            /* PCでは少し広めのパディング */
            .main-content {
                padding: 80px 40px 40px;
            }
        }

        /* --- モーダル (設定用) --- */
        .modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.5); z-index: 2000;
            justify-content: center; align-items: center;
            backdrop-filter: blur(2px);
        }
        .modal-overlay.active { display: flex; }
        .modal-box {
            background: var(--bg-card); color: var(--text-main);
            width: 90%; max-width: 400px;
            padding: 24px; border-radius: 16px;
            box-shadow: 0 10px 25px var(--shadow-color);
        }
        .modal-title { font-size: 20px; margin-bottom: 20px; font-weight: bold; }
        .modal-item { margin-bottom: 20px; }
        .modal-item label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-sub); }
        .modal-actions { text-align: right; margin-top: 24px; }

        /* --- オーバーレイ (スマホメニュー用) --- */
        .overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.3); z-index: 999;
        }
        @media (max-width: 767px) { .overlay.active { display: block; } }

        /* --- 汎用スタイル --- */
        h2 { font-size: 24px; font-weight: 400; color: var(--text-main); margin-bottom: 24px; display: flex; align-items: center; flex-wrap: wrap; }
        .fav-header-btn { background: none; border: none; cursor: pointer; margin-left: 10px; color: var(--text-sub); font-size: 1.5rem; }
        .fav-header-btn.active { color: var(--accent-yellow); }

        .flat-list-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 0; border-bottom: 1px solid var(--border-color);
            cursor: pointer; transition: background-color 0.1s;
        }
        .flat-list-item:hover { background-color: var(--hover-bg); }
        .flat-item-name { font-size: 16px; font-weight: 500; }

        input[type="text"], input[type="number"], select {
            width: 100%; padding: 12px 16px; margin-bottom: 20px;
            border: 1px solid var(--border-color); border-radius: 4px;
            background-color: var(--bg-input); color: var(--text-main);
            box-sizing: border-box; font-size: 16px;
        }
        input:focus, select:focus { outline: 2px solid var(--text-main); border-color: transparent; }

        button.action-btn {
            padding: 10px 24px; background-color: var(--accent-red); color: #fff;
            border: none; border-radius: 20px; cursor: pointer;
            font-size: 14px; font-weight: 500; transition: opacity 0.2s;
        }
        button.action-btn:hover { opacity: 0.9; }
        [data-theme="dark"] button.action-btn { color: #331200; font-weight: bold; }

    </style>
</head>
<body>

    <div class="header-controls">
        <button class="icon-btn" onclick="toggleMenu()" title="メニュー">
            <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
        </button>
        <button class="icon-btn" onclick="handleNav('home')" title="ホーム">
            <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
        </button>
    </div>

    <div class="overlay" onclick="toggleMenu()"></div>

    <nav class="sidebar" id="sidebar">
        <div class="sidebar-content" id="menu-list"></div>
        <div class="sidebar-footer">
            <div class="nav-item" onclick="openSettings()">
                <svg viewBox="0 0 24 24" style="width:20px; height:20px; margin-right:12px; fill:currentColor;"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.04.17 0 .4.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.09.47 0 .59-.22l1.92-3.32c.04-.22 0-.45-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                <span>設定</span>
            </div>
        </div>
    </nav>

    <div class="main-content" id="app"></div>

    <div class="modal-overlay" id="settings-modal" onclick="closeSettings(event)">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-title">設定</div>
            
            <div class="modal-item">
                <label for="theme-select">テーマ</label>
                <select id="theme-select" onchange="changeTheme(this.value)">
                    <option value="light">ホワイト (ライト)</option>
                    <option value="dark">ダーク</option>
                    <option value="system">システム (端末の設定に合わせる)</option>
                </select>
            </div>

            <div class="modal-actions">
                <button class="action-btn" onclick="closeSettings()">閉じる</button>
            </div>
        </div>
    </div>

    <script>
        const sidebar = document.getElementById('sidebar');
        const overlay = document.querySelector('.overlay');
        const app = document.getElementById('app');
        const settingsModal = document.getElementById('settings-modal');
        let allToolsData = [];

        function initTheme() {
            const savedTheme = localStorage.getItem('mtools_theme') || 'system';
            document.getElementById('theme-select').value = savedTheme;
            applyTheme(savedTheme);

            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (localStorage.getItem('mtools_theme') === 'system') {
                    applyTheme('system');
                }
            });
        }

        function changeTheme(mode) {
            localStorage.setItem('mtools_theme', mode);
            applyTheme(mode);
        }

        function applyTheme(mode) {
            let isDark = false;
            if (mode === 'system') {
                isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            } else if (mode === 'dark') {
                isDark = true;
            }
            if (isDark) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
        }

        function openSettings() {
            settingsModal.classList.add('active');
            if (window.innerWidth < 768 && sidebar.classList.contains('active')) {
                toggleMenu();
            }
        }

        function closeSettings(event) {
            if (event && event.target !== settingsModal && event.target.tagName !== 'BUTTON') return;
            settingsModal.classList.remove('active');
        }

        function init() {
            initTheme(); 
            if (window.innerWidth >= 768) sidebar.classList.add('active');
            
            loadMenu().then(() => {
                const hash = window.location.hash.replace('#', '');
                loadTool(hash || 'home');
            });
        }

        function toggleMenu() {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        async function loadMenu() {
            try {
                const res = await fetch('/api/tools');
                allToolsData = await res.json();
                renderSidebar();
            } catch (e) {
                console.error(e);
            }
        }

        function renderSidebar() {
            const list = document.getElementById('menu-list');
            list.innerHTML = '';
            
            allToolsData.forEach(tool => {
                const div = document.createElement('div');
                div.className = 'nav-item';
                div.textContent = tool.name;
                div.id = `nav-${tool.id}`;
                div.onclick = () => handleNav(tool.id);
                list.appendChild(div);
            });
        }

        function handleNav(id) {
            loadTool(id);
            if (window.innerWidth < 768 && sidebar.classList.contains('active')) {
                toggleMenu();
            }
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('current'));
            const active = document.getElementById(`nav-${id}`);
            if(active) active.classList.add('current');
        }

        async function loadTool(toolId) {
            window.location.hash = toolId;
            
            if (toolId === 'home') {
                renderHome();
                return;
            }

            try {
                const tool = allToolsData.find(t => t.id === toolId);
                const path = tool ? `/tools/${tool.file}` : `/tools/${toolId}.html`;
                
                const res = await fetch(path);
                if (!res.ok) throw new Error('Tool not found');
                const html = await res.text();
                
                app.innerHTML = html;
                executeScripts(app);

                const header = app.querySelector('h2');
                if (header) {
                    const favBtn = document.createElement('button');
                    favBtn.className = 'fav-header-btn';
                    favBtn.title = 'お気に入りに追加/削除';
                    updateFavBtnState(favBtn, toolId);
                    
                    favBtn.onclick = () => {
                        toggleFavorite(toolId);
                        updateFavBtnState(favBtn, toolId);
                    };
                    header.appendChild(favBtn);
                }

            } catch (e) {
                app.innerHTML = `<p>ページが見つかりません。</p><button class="action-btn" onclick="handleNav('home')">ホームへ戻る</button>`;
            }
        }

        function updateFavBtnState(btn, id) {
            const isFav = getFavorites().includes(id);
            btn.innerHTML = isFav ? '★' : '☆';
            if (isFav) btn.classList.add('active');
            else btn.classList.remove('active');
        }

        function renderHome() {
            const favIds = getFavorites();
            const favTools = allToolsData.filter(t => favIds.includes(t.id));
            const allTools = allToolsData;

            let html = `<h2>ホーム</h2>`;

            if (favTools.length > 0) {
                html += `<div style="margin-bottom: 30px;"><small style="color:var(--text-sub); font-weight:bold;">お気に入り</small>`;
                favTools.forEach(tool => {
                    html += `<div class="flat-list-item" onclick="handleNav('${tool.id}')">
                                <span class="flat-item-name">★ ${tool.name}</span>
                                <span style="color:var(--text-sub);">></span>
                             </div>`;
                });
                html += `</div>`;
            }

            html += `<div><small style="color:var(--text-sub); font-weight:bold;">すべてのツール</small>`;
            allTools.forEach(tool => {
                html += `<div class="flat-list-item" onclick="handleNav('${tool.id}')">
                            <span class="flat-item-name">${tool.name}</span>
                            <span style="color:var(--text-sub);">></span>
                         </div>`;
            });
            html += `</div>`;

            app.innerHTML = html;
        }

        function getFavorites() {
            return JSON.parse(localStorage.getItem('mtools_favs') || '[]');
        }

        function toggleFavorite(id) {
            let favs = getFavorites();
            if (favs.includes(id)) favs = favs.filter(f => f !== id);
            else favs.push(id);
            localStorage.setItem('mtools_favs', JSON.stringify(favs));
        }

        function executeScripts(container) {
            container.querySelectorAll('script').forEach(oldScript => {
                const newScript = document.createElement('script');
                Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                oldScript.parentNode.replaceChild(newScript, oldScript);
            });
        }

        init();
        
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768 && !sidebar.classList.contains('active')) {
                sidebar.classList.add('active');
            }
            if (window.innerWidth < 768 && sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            }
        });
    </script>
</body>
</html>